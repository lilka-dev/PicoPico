name: firmware

on:
  push:
    branches: [ master ]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: davidv27/picopico-builder:0.0.5
      volumes:
        - "${{ github.workspace }}:/src"
      env:
        GIT_SSL_NO_VERIFY: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build 3DS
        run: mkdir build-3ds && cd build-3ds && cmake .. -DBACKEND=THREEDS && make -j

      - name: Build android
        run: mkdir build-android && cd build-android && cmake .. -DANDROIDSDK=/android_sdk -DBACKEND=ANDROID && make -j

      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        with:
          name: 3DS Cart
          path: build-3ds/3ds_pico.3dsx

      - name: Archive production artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Android APP
          path: build-android/cnfgtest.apk

  lilka:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
            ./lilka/.pio
          key: ${{ runner.os }}-lilka

      - uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install PlatformIO Core
        run: pip install --upgrade platformio

      - name: Build Lilka firmware
        run: |
          cd lilka
          mkdir -p out
          pio run -e lilka_v2
          cp .pio/build/lilka_v2/firmware.bin out/picopico_lilka.bin
          cp .pio/build/lilka_v2/partitions.bin out/partitions.bin
          cp .pio/build/lilka_v2/bootloader.bin out/bootloader.bin
          pip install esptool
          esptool.py --chip esp32s3 merge_bin \
            -o out/PicoPico_Lilka_merged.bin \
            0x0 out/bootloader.bin \
            0x8000 out/partitions.bin \
            0x10000 out/picopico_lilka.bin

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PicoPico-Lilka-firmware
          path: lilka/out/*.bin

      - name: Upload Lilka bins to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: lilka/out/*.bin
